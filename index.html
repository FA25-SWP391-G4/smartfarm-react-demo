<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmartFarm Portal (React + Bootstrap + Chart.js)</title>
    <!-- Bootstrap 5 CSS (no jQuery needed) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root{--line:#e5e7eb;--ink:#111827;--muted:#6b7280;--brand:#0ea5e9;--bg:#f9fafb;--card:#ffffff}
      body.dark{--line:#374151;--ink:#f9fafb;--muted:#9ca3af;--brand:#22d3ee;--bg:#0b1220;--card:#101826}
      body{background:var(--bg); color:var(--ink)}
      .card, .modal-content{background:var(--card); color:var(--ink); border-color:var(--line)}
      .border-soft{border:1px solid var(--line)}
      .nav-link.active{color:var(--brand)!important}
      .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.35rem .6rem;border:1px solid var(--line);border-radius:999px;background:#eef2ff;color:#475569;font-weight:600;font-size:.8rem}
      .badge-ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
      .badge-warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
      .badge-crit{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
      canvas{background:var(--card); border:1px solid var(--line); border-radius: .75rem}
    </style>
    <!-- React & Babel (UMD) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Bootstrap 5 JS (no jQuery) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js v4 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      // ============== utils ==============
      const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
      const now = () => Date.now();

      // ============== Auth store (localStorage) ==============
      const AuthContext = React.createContext();
      function useLocalStorage(key, initial){
        const [val, setVal] = React.useState(() => {
          try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; }catch(e){ return initial; }
        });
        React.useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }, [key,val]);
        return [val, setVal];
      }

      // ============== Seed devices ==============
      function makeSeed(){
        const devices = [
          { id:1,name:'SoilMoisture - Lu·ªëng A',type:'soil', unit:'%',   loc:'Nh√† l∆∞·ªõi A1', min:35,max:70,  value:48,     history:[],updated:now() },
          { id:2,name:'DHT22 - Nh√† l∆∞·ªõi',     type:'dht',  unit:'¬∞C/%',loc:'Nh√† l∆∞·ªõi A1', min:18,max:32,  value:[28,65], history:[],updated:now() },
          { id:3,name:'Water Level - B·ªÉ t∆∞·ªõi',type:'water',unit:'cm',  loc:'B·ªÉ 1',        min:20,max:120, value:55,     history:[],updated:now() },
          { id:4,name:'B∆°m t∆∞·ªõi 1',           type:'pump', unit:'',    loc:'B·ªÉ 1',        min:0, max:1,   value:'OFF',  history:[],updated:now() }
        ];
        devices.forEach(d=>{
          const base = typeof d.value==='number' ? d.value : Array.isArray(d.value) ? d.value[0] : 0;
          for(let i=0;i<20;i++){
            d.history.push({t: now()-(20-i)*6000, v: Math.round(base+(Math.random()*4-2))});
          }
        });
        return devices;
      }

      // ============== Theme ==============
      function useTheme(){
        const [theme, setTheme] = useLocalStorage('sf_theme', 'light');
        React.useEffect(()=>{
          document.body.classList.toggle('dark', theme==='dark');
        }, [theme]);
        return [theme, setTheme];
      }

      // ============== App ==============
      function App(){
        const [theme, setTheme] = useTheme();
        const [user, setUser] = useLocalStorage('sf_user', null);
        const [page, setPage] = React.useState('home');
        const [devices, setDevices] = useLocalStorage('sf_devices', makeSeed());
        const [selectedId, setSelectedId] = React.useState(devices[0]?.id ?? null);
        const selected = React.useMemo(()=> devices.find(d=>d.id===selectedId) || devices[0] || null, [devices, selectedId]);

        // fake realtime update
        React.useEffect(()=>{
          const t = setInterval(()=>{
            setDevices(prev => prev.map(d=>{
              if(d.type==='pump') return d;
              if(d.type==='dht'){
                const t = clamp((d.value?.[0] ?? 25)+(Math.random()*2-1), 10, 45);
                const h = clamp((d.value?.[1] ?? 60)+(Math.random()*4-2), 30, 95);
                return { ...d, value:[Math.round(t), Math.round(h)], history:[...d.history, {t:now(), v: Math.round(t)}], updated: now() };
              } else {
                const base = typeof d.value==='number'?d.value:50;
                const nv = Math.round(clamp(base+(Math.random()*2-1), -1000, 1000));
                return { ...d, value:nv, history:[...d.history, {t:now(), v:nv}], updated: now() };
              }
            }));
          }, 5000);
          return ()=>clearInterval(t);
        }, [setDevices]);

        const auth = React.useMemo(()=>({user, setUser}), [user]);

        const requireAuth = (next) => {
          if(!user) setPage('login'); else setPage(next);
        };

        return (
          <AuthContext.Provider value={auth}>
            <Header theme={theme} onToggleTheme={()=>setTheme(theme==='dark'?'light':'dark')} page={page} setPage={setPage} requireAuth={requireAuth} />
            <main className="container py-4">
              {page==='home' && <Home onGoDevices={()=>requireAuth('devices')} />}
              {page==='login' && <Login onDone={()=>setPage('devices')} />}
              {page==='devices' && user && (
                <Devices
                  devices={devices}
                  setDevices={setDevices}
                  selectedId={selected?.id ?? null}
                  setSelectedId={setSelectedId}
                />
              )}
              {page==='settings' && user && <Settings />}
              {page==='reports' && user && <Reports />}
            </main>
          </AuthContext.Provider>
        );
      }

      // ============== Header ==============
      function Header({theme, onToggleTheme, page, setPage, requireAuth}){
        const {user, setUser} = React.useContext(AuthContext);
        const [open, setOpen] = React.useState(false);
        const navClass = (p)=> 'nav-link '+(page===p?'active':'');
        return (
          <header className="border-bottom border-soft">
            <div className="container d-flex align-items-center py-2 gap-3">
              <div className="fw-bold text-info">üå± SmartFarm LLC</div>
              <ul className="nav me-auto">
                <li className="nav-item"><a className={navClass('home')} href="#" onClick={(e)=>{e.preventDefault(); setPage('home')}}>Home</a></li>
                <li className="nav-item"><a className={navClass('devices')} href="#" onClick={(e)=>{e.preventDefault(); requireAuth('devices')}}>Devices</a></li>
                <li className="nav-item"><a className={navClass('reports')} href="#" onClick={(e)=>{e.preventDefault(); requireAuth('reports')}}>Reports</a></li>
                <li className="nav-item"><a className={navClass('settings')} href="#" onClick={(e)=>{e.preventDefault(); requireAuth('settings')}}>Settings</a></li>
              </ul>
              <button className="btn btn-outline-secondary" title="ƒê·ªïi giao di·ªán" onClick={onToggleTheme}>üí°</button>
              {!user ? (
                <button className="btn btn-primary" onClick={()=>setPage('login')}>Sign in</button>
              ) : (
                <div className="position-relative">
                  <button className="btn btn-outline-secondary" onClick={()=>setOpen(!open)}>Account ‚ñæ</button>
                  {open && (
                    <div className="position-absolute end-0 mt-2 p-2 rounded-3 border-soft" style={{minWidth:220, background:'var(--card)'}}>
                      <div className="small text-muted px-2 pb-1">Signed in as</div>
                      <div className="px-2 fw-semibold">{user.name||user.email}</div>
                      <hr className="my-2"/>
                      <button className="btn w-100 text-start" onClick={()=>{ setOpen(false); requireAuth('settings'); }}>Profile & Settings</button>
                      <button className="btn w-100 text-start text-danger" onClick={()=>{ setUser(null); setOpen(false); }}>Sign out</button>
                    </div>
                  )}
                </div>
              )}
            </div>
          </header>
        );
      }

      // ============== Pages ==============
      function Home({onGoDevices}){
        return (
          <section className="card p-4">
            <div className="row g-4 align-items-center">
              <div className="col-md-7">
                <h1 className="mb-2">Welcome to SmartFarm</h1>
                <p className="text-muted">Gi√°m s√°t ƒë·ªô ·∫©m ƒë·∫•t, nhi·ªát ƒë·ªô/ƒë·ªô ·∫©m, m·ª±c n∆∞·ªõc v√† b∆°m t∆∞·ªõi theo th·ªùi gian th·ª±c.</p>
                <button className="btn btn-primary" onClick={onGoDevices}>M·ªü Devices</button>
              </div>
              <div className="col-md-5">
                <div className="border-soft rounded p-3 text-muted">Demo portal</div>
              </div>
            </div>
          </section>
        );
      }

      function Login({onDone}){
        const {user, setUser} = React.useContext(AuthContext);
        const [liEmail, setLiEmail] = React.useState('');
        const [liPass, setLiPass] = React.useState('');
        const [suName, setSuName] = React.useState('');
        const [suEmail, setSuEmail] = React.useState('');
        const [suPass, setSuPass] = React.useState('');
        const [suPass2, setSuPass2] = React.useState('');
        return (
          <section className="row g-3">
            <div className="col-md-6">
              <div className="card p-3">
                <h3>Sign in</h3>
                <p className="text-muted">T√†i kho·∫£n demo l∆∞u trong tr√¨nh duy·ªát.</p>
                <label className="form-label">Email<input type="email" className="form-control" value={liEmail} onChange={e=>setLiEmail(e.target.value)} /></label>
                <label className="form-label">Password<input type="password" className="form-control" value={liPass} onChange={e=>setLiPass(e.target.value)} /></label>
                <div className="d-flex gap-2 mt-2">
                  <button className="btn btn-primary" onClick={()=>{
                    const u = user; // one-account demo
                    if(u && u.email===liEmail && u.password===liPass){ alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng'); onDone(); }
                    else alert('Sai email/m·∫≠t kh·∫©u ho·∫∑c ch∆∞a c√≥ t√†i kho·∫£n. Vui l√≤ng ƒëƒÉng k√Ω.');
                  }}>Sign in</button>
                  <button className="btn btn-outline-secondary" onClick={()=>{ setUser(null); alert('ƒê√£ ƒëƒÉng xu·∫•t'); }}>Sign out</button>
                </div>
              </div>
            </div>
            <div className="col-md-6">
              <div className="card p-3">
                <h3>Create account</h3>
                <div className="row g-2">
                  <div className="col-6"><label className="form-label">Name<input className="form-control" value={suName} onChange={e=>setSuName(e.target.value)} /></label></div>
                  <div className="col-6"><label className="form-label">Email<input type="email" className="form-control" value={suEmail} onChange={e=>setSuEmail(e.target.value)} /></label></div>
                  <div className="col-6"><label className="form-label">Password<input type="password" className="form-control" value={suPass} onChange={e=>setSuPass(e.target.value)} /></label></div>
                  <div className="col-6"><label className="form-label">Confirm<input type="password" className="form-control" value={suPass2} onChange={e=>setSuPass2(e.target.value)} /></label></div>
                </div>
                <button className="btn btn-primary mt-2" onClick={()=>{
                  if(!suName || !suEmail || !suPass){ alert('ƒêi·ªÅn ƒë·ªß Name/Email/Password'); return; }
                  if(suPass !== suPass2){ alert('M·∫≠t kh·∫©u kh√¥ng kh·ªõp'); return; }
                  setUser({name:suName,email:suEmail,password:suPass});
                  alert('T·∫°o t√†i kho·∫£n xong!'); onDone();
                }}>Sign up</button>
              </div>
            </div>
          </section>
        );
      }

      function Settings(){
        const {user, setUser} = React.useContext(AuthContext);
        const [name, setName] = React.useState(user?.name||'');
        const [cur, setCur] = React.useState('');
        const [n1, setN1] = React.useState('');
        const [n2, setN2] = React.useState('');
        return (
          <section className="row g-3">
            <div className="col-md-6">
              <div className="card p-3">
                <h3>Profile</h3>
                <label className="form-label">Name<input className="form-control" value={name} onChange={e=>setName(e.target.value)} /></label>
                <label className="form-label">Email<input className="form-control" value={user?.email||''} disabled /></label>
                <button className="btn btn-primary mt-2" onClick={()=>{ setUser({...user, name: name||user?.name}); alert('Saved'); }}>Save Profile</button>
              </div>
            </div>
            <div className="col-md-6">
              <div className="card p-3">
                <h3>Change Password</h3>
                <label className="form-label">Current<input type="password" className="form-control" value={cur} onChange={e=>setCur(e.target.value)} /></label>
                <div className="row g-2">
                  <div className="col-6"><label className="form-label">New<input type="password" className="form-control" value={n1} onChange={e=>setN1(e.target.value)} /></label></div>
                  <div className="col-6"><label className="form-label">Confirm<input type="password" className="form-control" value={n2} onChange={e=>setN2(e.target.value)} /></label></div>
                </div>
                <button className="btn btn-primary mt-2" onClick={()=>{
                  if(user?.password !== cur){ alert('Sai m·∫≠t kh·∫©u hi·ªán t·∫°i'); return; }
                  if(!n1 || n1!==n2){ alert('M·∫≠t kh·∫©u m·ªõi kh√¥ng h·ª£p l·ªá'); return; }
                  setUser({...user, password:n1});
                  setCur(''); setN1(''); setN2('');
                  alert('ƒê·ªïi m·∫≠t kh·∫©u xong');
                }}>Update Password</button>
              </div>
            </div>
          </section>
        );
      }

      function Reports(){
        return (
          <section>
            <div className="card p-3">
              <h3>B√°o c√°o</h3>
              <p className="text-muted">(S·∫Øp c√≥) Xu·∫•t CSV, th·ªëng k√™ c·∫£nh b√°o, t·ªïng h·ª£p th√°ng‚Ä¶</p>
            </div>
          </section>
        );
      }

      // ============== Devices ==============
      function Devices({devices, setDevices, selectedId, setSelectedId}){
        const [filter, setFilter] = React.useState('all');
        const filtered = React.useMemo(()=> devices.filter(d=> filter==='all' || d.type===filter), [devices, filter]);
        const selected = React.useMemo(()=> devices.find(d=> d.id===selectedId) || filtered[0] || null, [devices, filtered, selectedId]);

        React.useEffect(()=>{ if(selected && selected.id!==selectedId) setSelectedId(selected.id); }, [selected]);

        function addDevice({name,type,unit,loc,min,max}){
          if(!name||!loc) return alert('ƒêi·ªÅn ƒë·ªß T√™n & V·ªã tr√≠');
          if(type!=='pump' && (!Number.isFinite(min) || !Number.isFinite(max) || min>=max)) return alert('Ng∆∞·ª°ng min/max kh√¥ng h·ª£p l·ªá');
          const id = (devices.reduce((m,d)=>Math.max(m,d.id),0) || 0)+1;
          const value = type==='dht'?[26,60] : (type==='pump'?'OFF' : Math.round((min+max)/2));
          const nd = {id,name,type,unit,loc,min:min||0,max:max||0,value,history:[],updated:now()};
          setDevices([nd, ...devices]);
          setSelectedId(id);
          alert('ƒê√£ th√™m thi·∫øt b·ªã');
        }

        function removeSelected(){
          if(!selected) return;
          if(!confirm('X√≥a thi·∫øt b·ªã '+selected.name+'?')) return;
          const next = devices.filter(d=>d.id!==selected.id);
          setDevices(next);
          setSelectedId(next[0]?.id ?? null);
        }

        function saveEdit(payload){
          setDevices(devices.map(d=> d.id===selected.id ? {...d, ...payload, updated:now()} : d));
        }

        return (
          <div className="row g-3">
            <div className="col-lg-4">
              <div className="card p-0">
                <div className="p-3 border-bottom border-soft d-flex align-items-center gap-2">
                  <span className="chip">B·ªô l·ªçc</span>
                  <select className="form-select form-select-sm w-auto" value={filter} onChange={e=>setFilter(e.target.value)}>
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="soil">ƒê·ªô ·∫©m ƒë·∫•t</option>
                    <option value="dht">Nhi·ªát ƒë·ªô/ƒê·ªô ·∫©m</option>
                    <option value="water">M·ª±c n∆∞·ªõc</option>
                    <option value="pump">B∆°m</option>
                  </select>
                  <span className="ms-auto text-muted small">({filtered.length})</span>
                </div>
                <div style={{maxHeight: '48vh', overflowY:'auto'}}>
                  {filtered.map(d=>{
                    const s = statusOf(d);
                    const badge = s==='ok'?'badge-ok':s==='warn'?'badge-warn':'badge-crit';
                    const display = d.type==='dht' ? `${Math.round(d.value[0])}¬∞C / ${Math.round(d.value[1])}%` : (d.type==='pump'? d.value : `${Math.round(d.value)}${d.unit}`);
                    return (
                      <div key={d.id} role="button" className={`p-3 border-top ${selected?.id===d.id?'bg-body-secondary':''}`} onClick={()=>setSelectedId(d.id)}>
                        <div className="d-flex align-items-center gap-2">
                          <span className={`badge ${badge}`}>{s==='ok'?'B√¨nh th∆∞·ªùng':s==='warn'?'C·∫£nh b√°o':'Nguy c·∫•p'}</span>
                          <span className="text-muted">{d.loc}</span>
                          <span className="ms-auto border-soft rounded px-2 fw-bold">{display}</span>
                        </div>
                        <div className="d-flex align-items-center gap-2 mt-1">
                          <strong>{d.name}</strong>
                          <span className="ms-auto text-muted small">{new Date(d.updated).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'})}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="p-3">
                  <AddDeviceForm onAdd={addDevice} />
                </div>
              </div>
            </div>
            <div className="col-lg-8">
              <DeviceDetail device={selected} onSave={saveEdit} onDelete={removeSelected} />
            </div>
          </div>
        );
      }

      function statusOf(d){
        if(!d) return 'ok';
        if(d.type==='pump') return d.value==='ON'?'ok':'warn';
        const val = d.type==='dht' ? d.value[0] : d.value;
        if(val < d.min-5 || val > d.max+5) return 'crit';
        if(val < d.min || val > d.max) return 'warn';
        return 'ok';
      }

      function AddDeviceForm({onAdd}){
        const [name,setName]=React.useState('');
        const [type,setType]=React.useState('soil');
        const [unit,setUnit]=React.useState('');
        const [loc,setLoc]=React.useState('');
        const [min,setMin]=React.useState(35);
        const [max,setMax]=React.useState(70);
        return (
          <div className="card p-3">
            <h5>Ôºã Th√™m thi·∫øt b·ªã</h5>
            <div className="row g-2">
              <div className="col-6"><label className="form-label">T√™n<input className="form-control" value={name} onChange={e=>setName(e.target.value)} placeholder="SoilMoisture - Lu·ªëng B"/></label></div>
              <div className="col-6"><label className="form-label">Lo·∫°i<select className="form-select" value={type} onChange={e=>setType(e.target.value)}>
                <option value="soil">ƒê·ªô ·∫©m ƒë·∫•t</option><option value="dht">Nhi·ªát ƒë·ªô/ƒê·ªô ·∫©m</option><option value="water">M·ª±c n∆∞·ªõc</option><option value="pump">B∆°m</option>
              </select></label></div>
              <div className="col-6"><label className="form-label">ƒê∆°n v·ªã<input className="form-control" value={unit} onChange={e=>setUnit(e.target.value)} placeholder="%, cm, ¬∞C/%"/></label></div>
              <div className="col-6"><label className="form-label">V·ªã tr√≠<input className="form-control" value={loc} onChange={e=>setLoc(e.target.value)} placeholder="Nh√† l∆∞·ªõi A2"/></label></div>
              <div className="col-6"><label className="form-label">Ng∆∞·ª°ng min<input type="number" className="form-control" value={min} onChange={e=>setMin(+e.target.value)} /></label></div>
              <div className="col-6"><label className="form-label">Ng∆∞·ª°ng max<input type="number" className="form-control" value={max} onChange={e=>setMax(+e.target.value)} /></label></div>
            </div>
            <button className="btn btn-primary mt-2" onClick={()=>onAdd({name,type,unit,loc,min:+min,max:+max})}>Th√™m</button>
          </div>
        );
      }

      function DeviceDetail({device, onSave, onDelete}){
        const [modalOpen, setModalOpen] = React.useState(false);
        if(!device) return <div className="card p-3">Ch∆∞a c√≥ thi·∫øt b·ªã</div>;
        const s = statusOf(device);
        const badge = s==='ok'?'badge-ok':s==='warn'?'badge-warn':'badge-crit';
        const display = device.type==='dht' ? `${Math.round(device.value[0])}¬∞C / ${Math.round(device.value[1])}%` : (device.type==='pump'? device.value : `${Math.round(device.value)}${device.unit}`);
        return (
          <div className="card p-3">
            <h3>Chi ti·∫øt thi·∫øt b·ªã</h3>
            <div className="row g-2">
              <InfoField label="Tr·∫°ng th√°i"><span className={`badge ${badge}`}>{s==='ok'?'B√¨nh th∆∞·ªùng':s==='warn'?'C·∫£nh b√°o':'Nguy c·∫•p'}</span></InfoField>
              <InfoField label="T√™n">{device.name}</InfoField>
              <InfoField label="Lo·∫°i">{labelType(device.type)}</InfoField>
              <InfoField label="V·ªã tr√≠">{device.loc}</InfoField>
              <InfoField label="Gi√° tr·ªã">{display}</InfoField>
              <InfoField label="Ng∆∞·ª°ng">{device.min}{device.unit||''} ‚Äì {device.max}{device.unit||''}</InfoField>
            </div>
            <div className="d-flex gap-2 my-2">
              {device.type==='pump' && (
                <button className="btn btn-warning" onClick={()=> onSave({value: device.value==='ON'?'OFF':'ON'})}>B·∫≠t/T·∫Øt B∆°m</button>
              )}
              <button className="btn btn-outline-secondary" onClick={()=>setModalOpen(true)}>S·ª≠a</button>
              <button className="btn btn-danger" onClick={onDelete}>X√≥a</button>
            </div>
            <div className="mb-3">
              <h5>Bi·ªÉu ƒë·ªì (30 ƒëi·ªÉm g·∫ßn nh·∫•t)</h5>
              <LineChart data={device.history.slice(-30)} min={device.min} max={device.max} />
            </div>
            <div>
              <h5>Nh·∫≠t k√Ω ƒëo</h5>
              <div className="table-responsive">
                <table className="table align-middle">
                  <thead><tr><th>Th·ªùi gian</th><th>Gi√° tr·ªã</th><th>Tr·∫°ng th√°i</th></tr></thead>
                  <tbody>
                    {[...device.history.slice(-30)].reverse().map((h,idx)=>{
                      const ok = h.v>=device.min && h.v<=device.max;
                      return <tr key={idx}><td>{new Date(h.t).toLocaleTimeString('vi-VN')}</td><td>{device.type==='dht'? `${Math.round(h.v)}¬∞C` : `${Math.round(h.v)}${device.unit}`}</td><td>{ok?'B√¨nh th∆∞·ªùng':'Ngo√†i ng∆∞·ª°ng'}</td></tr>
                    })}
                  </tbody>
                </table>
              </div>
            </div>
            {modalOpen && <EditModal device={device} onClose={()=>setModalOpen(false)} onSave={onSave} />}
          </div>
        );
      }

      function labelType(t){
        return t==='soil'?'ƒê·ªô ·∫©m ƒë·∫•t' : t==='dht'?'Nhi·ªát ƒë·ªô/ƒê·ªô ·∫©m' : t==='water'?'M·ª±c n∆∞·ªõc':'B∆°m';
      }
      function InfoField({label, children}){
        return (
          <div className="col-md-3">
            <div className="p-2 rounded border-soft" style={{background:'rgba(148,163,184,.08)'}}>
              <div className="small text-muted">{label}</div>
              <div className="fw-bold">{children}</div>
            </div>
          </div>
        );
      }

      function EditModal({device, onClose, onSave}){
        const [name,setName]=React.useState(device.name);
        const [loc,setLoc]=React.useState(device.loc);
        const [unit,setUnit]=React.useState(device.unit);
        const [type,setType]=React.useState(device.type);
        const [min,setMin]=React.useState(device.min);
        const [max,setMax]=React.useState(device.max);
        return (
          <div className="modal d-flex" style={{background:'rgba(0,0,0,.35)'}}>
            <div className="modal-dialog">
              <div className="modal-content">
                <div className="modal-header"><h5 className="modal-title">S·ª≠a thi·∫øt b·ªã</h5><button className="btn-close" onClick={onClose}></button></div>
                <div className="modal-body">
                  <div className="row g-2">
                    <div className="col-6"><label className="form-label">T√™n<input className="form-control" value={name} onChange={e=>setName(e.target.value)} /></label></div>
                    <div className="col-6"><label className="form-label">V·ªã tr√≠<input className="form-control" value={loc} onChange={e=>setLoc(e.target.value)} /></label></div>
                    <div className="col-6"><label className="form-label">ƒê∆°n v·ªã<input className="form-control" value={unit} onChange={e=>setUnit(e.target.value)} /></label></div>
                    <div className="col-6"><label className="form-label">Lo·∫°i<select className="form-select" value={type} onChange={e=>setType(e.target.value)}>
                      <option value="soil">ƒê·ªô ·∫©m ƒë·∫•t</option><option value="dht">Nhi·ªát ƒë·ªô/ƒê·ªô ·∫©m</option><option value="water">M·ª±c n∆∞·ªõc</option><option value="pump">B∆°m</option>
                    </select></label></div>
                    <div className="col-6"><label className="form-label">Ng∆∞·ª°ng min<input type="number" className="form-control" value={min} onChange={e=>setMin(+e.target.value)} /></label></div>
                    <div className="col-6"><label className="form-label">Ng∆∞·ª°ng max<input type="number" className="form-control" value={max} onChange={e=>setMax(+e.target.value)} /></label></div>
                  </div>
                </div>
                <div className="modal-footer">
                  <button className="btn btn-secondary" onClick={onClose}>H·ªßy</button>
                  <button className="btn btn-primary" onClick={()=>{
                    if(!name||!loc) return alert('ƒêi·ªÅn ƒë·ªß T√™n & V·ªã tr√≠');
                    if(type!=='pump' && (!Number.isFinite(min)||!Number.isFinite(max) || min>=max)) return alert('Ng∆∞·ª°ng min/max kh√¥ng h·ª£p l·ªá');
                    onSave({name,loc,unit,type,min,max}); onClose();
                  }}>L∆∞u</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ============== Chart.js wrapper ==============
      function LineChart({data, min, max}){
        const ref = React.useRef();
        const chartRef = React.useRef();
        React.useEffect(()=>{
          if(!ref.current) return;
          const ctx = ref.current.getContext('2d');
          const labels = data.map(p=> new Date(p.t).toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit'}));
          const values = data.map(p=> p.v);
          chartRef.current = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Gi√° tr·ªã', data: values }] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              elements: { line: { tension: .3 }, point: { radius: 0 } },
              scales: {
                y: { suggestedMin: Math.min(min, ...values)-2, suggestedMax: Math.max(max, ...values)+2 }
              }
            }
          });
          return ()=>{ chartRef.current?.destroy(); };
        }, [JSON.stringify(data), min, max]);
        return <div style={{height:180}}><canvas ref={ref} /></div>;
      }

      // ============== Render ==============
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App/>);
    </script>
  </body>
</html>
